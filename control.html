<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Panel - X-Toolz</title>
    
    <!-- Tailwind CSS & Font Awesome -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Google Fonts: Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #111827; color: #f9fafb; }
        .form-input { background-color: #1f2937; border: 1px solid #374151; color: #f9fafb; transition: all 0.2s ease-in-out; }
        .form-input:focus { border-color: #4f46e5; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.5); outline: none; }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .toast {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: bottom 0.5s ease-in-out;
            z-index: 100;
        }
        .toast.show { bottom: 20px; }
        .toast.success { background-color: #10b981; }
        .toast.error { background-color: #ef4444; }
    </style>
</head>
<body class="antialiased">

    <!-- Header -->
    <header class="bg-gray-900 text-white text-center p-6 shadow-lg">
        <h1 class="text-3xl font-bold tracking-tight"><i class="fas fa-cogs mr-3"></i>Control Panel X-Toolz</h1>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- Form Section -->
        <div class="lg:col-span-1">
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg sticky top-8">
                <h2 id="form-title" class="text-2xl font-bold mb-4">Tambah Tool Baru</h2>
                <form id="tool-form">
                    <input type="hidden" id="tool-id">
                    <div class="mb-4">
                        <label for="tool-name" class="block text-sm font-medium text-gray-300 mb-1">Nama Tool</label>
                        <input type="text" id="tool-name" class="w-full form-input rounded-lg p-2.5" required>
                    </div>
                    <div class="mb-4">
                        <label for="tool-desc" class="block text-sm font-medium text-gray-300 mb-1">Deskripsi Singkat</label>
                        <textarea id="tool-desc" rows="3" class="w-full form-input rounded-lg p-2.5" required></textarea>
                    </div>
                    <div class="mb-6">
                        <label for="tool-url" class="block text-sm font-medium text-gray-300 mb-1">URL Download (catbox.moe)</label>
                        <input type="url" id="tool-url" class="w-full form-input rounded-lg p-2.5" required>
                    </div>
                    <div class="flex space-x-2">
                        <button type="submit" id="submit-btn" class="flex-grow bg-indigo-600 text-white font-semibold py-2.5 px-4 rounded-lg transition-all duration-300 hover:bg-indigo-700">
                            <i class="fas fa-plus-circle mr-2"></i> Tambah Tool
                        </button>
                        <button type="button" id="cancel-edit-btn" class="hidden bg-gray-600 text-white font-semibold py-2.5 px-4 rounded-lg transition-all duration-300 hover:bg-gray-700">
                            Batal
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tools List Section -->
        <div class="lg:col-span-2">
            <h2 class="text-2xl font-bold mb-4">Daftar Tools Terpasang</h2>
            <div id="admin-tools-list" class="space-y-4">
                <div id="admin-loading-indicator" class="flex justify-center items-center h-64">
                    <i class="fas fa-spinner fa-spin fa-3x text-indigo-400"></i>
                </div>
            </div>
        </div>
    </main>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
            <h3 class="text-xl font-bold text-white mb-2">Konfirmasi Hapus</h3>
            <p class="text-gray-300 mb-6">Apakah Anda yakin ingin menghapus tool "<span id="tool-name-to-delete" class="font-semibold"></span>"? Tindakan ini tidak dapat dibatalkan.</p>
            <div class="flex justify-end space-x-4">
                <button id="cancel-delete-btn" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">Batal</button>
                <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Ya, Hapus</button>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast-notification" class="toast"></div>

    <!-- Firebase SDK & Control Panel App JS -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="security.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const firebaseConfig = {
                apiKey: "AIzaSyAk-0bfLE8m00HMHGR4HFctW58KRWi_Psw",
                authDomain: "xbibz-tools.firebaseapp.com",
                databaseURL: "https://xbibz-tools-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "xbibz-tools",
                storageBucket: "xbibz-tools.appspot.com",
                messagingSenderId: "728866559765",
                appId: "1:728866559765:web:c44d19112638a86a377b1c",
                measurementId: "G-LFGHF7JXBN"
            };

            firebase.initializeApp(firebaseConfig);
            const database = firebase.database();
            const toolsRef = database.ref('tools');

            // --- Element References ---
            const form = {
                formEl: document.getElementById('tool-form'),
                title: document.getElementById('form-title'),
                idInput: document.getElementById('tool-id'),
                nameInput: document.getElementById('tool-name'),
                descInput: document.getElementById('tool-desc'),
                urlInput: document.getElementById('tool-url'),
                submitBtn: document.getElementById('submit-btn'),
                cancelBtn: document.getElementById('cancel-edit-btn')
            };
            const listEl = document.getElementById('admin-tools-list');
            const loadingIndicator = document.getElementById('admin-loading-indicator');
            const modal = {
                el: document.getElementById('delete-modal'),
                nameSpan: document.getElementById('tool-name-to-delete'),
                cancelBtn: document.getElementById('cancel-delete-btn'),
                confirmBtn: document.getElementById('confirm-delete-btn')
            };
            const toast = document.getElementById('toast-notification');

            // --- Toast Notification Logic ---
            function showToast(message, type = 'success') {
                toast.textContent = message;
                toast.className = `toast show ${type}`;
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }

            // --- Form Logic ---
            function resetForm() {
                form.formEl.reset();
                form.idInput.value = '';
                form.title.textContent = 'Tambah Tool Baru';
                form.submitBtn.innerHTML = '<i class="fas fa-plus-circle mr-2"></i> Tambah Tool';
                form.cancelBtn.classList.add('hidden');
            }

            form.formEl.addEventListener('submit', (e) => {
                e.preventDefault();
                const toolData = {
                    name: form.nameInput.value,
                    description: form.descInput.value,
                    url: form.urlInput.value,
                };
                const toolId = form.idInput.value;

                if (toolId) { // Update
                    database.ref(`tools/${toolId}`).update(toolData)
                        .then(() => {
                            resetForm();
                            showToast('Tool berhasil diperbarui!');
                        })
                        .catch(err => showToast(`Update gagal: ${err.message}`, 'error'));
                } else { // Create
                    toolsRef.push(toolData)
                        .then(() => {
                            form.formEl.reset();
                            showToast('Tool baru berhasil ditambahkan!');
                        })
                        .catch(err => showToast(`Gagal menambahkan: ${err.message}`, 'error'));
                }
            });

            form.cancelBtn.addEventListener('click', resetForm);

            // --- Display & Event Delegation ---
            toolsRef.on('value', (snapshot) => {
                listEl.innerHTML = '';
                loadingIndicator.style.display = 'none';
                const data = snapshot.val();

                if (data) {
                    Object.entries(data).forEach(([key, tool]) => {
                        const item = document.createElement('div');
                        item.className = 'bg-gray-800 p-4 rounded-lg flex items-center justify-between shadow transition-all hover:bg-gray-700/50';
                        item.innerHTML = `
                            <div class="flex-grow mr-4">
                                <p class="font-bold text-lg">${tool.name}</p>
                                <a href="${tool.url}" target="_blank" class="text-xs text-indigo-400 hover:underline break-all">${tool.url}</a>
                            </div>
                            <div class="flex-shrink-0 flex space-x-2">
                                <button data-key="${key}" class="edit-btn p-2 text-blue-400 hover:text-blue-300 transition-colors"><i class="fas fa-edit fa-fw"></i></button>
                                <button data-key="${key}" data-name="${tool.name}" class="delete-btn p-2 text-red-400 hover:text-red-300 transition-colors"><i class="fas fa-trash fa-fw"></i></button>
                            </div>
                        `;
                        listEl.appendChild(item);
                    });
                } else {
                    listEl.innerHTML = '<p class="text-center text-gray-500">Belum ada tool yang ditambahkan.</p>';
                }
            });

            listEl.addEventListener('click', (e) => {
                const target = e.target;
                const editBtn = target.closest('.edit-btn');
                const deleteBtn = target.closest('.delete-btn');

                if (editBtn) {
                    const key = editBtn.dataset.key;
                    database.ref(`tools/${key}`).once('value', (snapshot) => {
                        const tool = snapshot.val();
                        form.idInput.value = key;
                        form.nameInput.value = tool.name;
                        form.descInput.value = tool.description;
                        form.urlInput.value = tool.url;
                        form.title.textContent = 'Edit Tool';
                        form.submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i> Simpan Perubahan';
                        form.cancelBtn.classList.remove('hidden');
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    });
                }

                if (deleteBtn) {
                    modal.nameSpan.textContent = deleteBtn.dataset.name;
                    modal.confirmBtn.dataset.key = deleteBtn.dataset.key;
                    modal.el.classList.remove('hidden');
                }
            });

            // --- Modal Logic ---
            modal.cancelBtn.addEventListener('click', () => modal.el.classList.add('hidden'));
            modal.confirmBtn.addEventListener('click', (e) => {
                const key = e.currentTarget.dataset.key;
                database.ref(`tools/${key}`).remove()
                    .then(() => {
                        showToast('Tool berhasil dihapus.');
                        modal.el.classList.add('hidden');
                    })
                    .catch(err => showToast(`Gagal menghapus: ${err.message}`, 'error'));
            });
        });
    </script>
</body>
</html>